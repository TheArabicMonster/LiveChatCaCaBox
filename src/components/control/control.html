<!DOCTYPE html>
<html>

<head>
  <title>LiveChatCCB - Media Control Panel</title>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"
    integrity="sha384-Gr6Lu2Ajx28mzwyVR8CFkULdCU7kMlZ9UthllibdOSo6qAiN+yXNHqtgdTvFXMT4"
    crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .media-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .media-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .media-thumbnail {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #f3f4f6;
    }
  </style>
</head>

<body class="bg-gray-100">
  <div class="container mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">Media Control Panel</h1>
      <p class="text-gray-600">Select media files to display on stream</p>
    </header>

    <!-- Connection Status -->
    <div id="connection-status" class="mb-6 p-4 rounded-lg bg-yellow-100 border border-yellow-300">
      <p class="text-yellow-800">
        <span id="status-icon">⏳</span>
        <span id="status-text">Connecting...</span>
      </p>
    </div>

    <!-- Guild ID Input -->
    <div class="mb-6 bg-white rounded-lg shadow p-6">
      <label for="guild-id" class="block text-sm font-medium text-gray-700 mb-2">
        Discord Guild ID (Server ID)
      </label>
      <div class="flex gap-2">
        <input 
          type="text" 
          id="guild-id" 
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Enter your Discord Server ID"
        >
        <button 
          id="connect-btn"
          class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
        >
          Connect
        </button>
      </div>
      <p class="mt-2 text-sm text-gray-500">
        You can find your Guild ID by enabling Developer Mode in Discord and right-clicking your server
      </p>
    </div>

    <!-- Folder Path Configuration -->
    <div class="mb-6 bg-white rounded-lg shadow p-6">
      <label for="folder-path" class="block text-sm font-medium text-gray-700 mb-2">
        Custom Media Folder Path
      </label>
      <div class="flex gap-2">
        <input 
          type="text" 
          id="folder-path" 
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          placeholder="/path/to/your/media/folder"
        >
        <button 
          id="load-folder-btn"
          class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
        >
          Load Folder
        </button>
      </div>
    </div>

    <!-- File Upload Section -->
    <div class="mb-6 bg-white rounded-lg shadow p-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Or Upload Media Files
      </label>
      <input 
        type="file" 
        id="file-upload" 
        accept="image/*,video/*"
        multiple
        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
      >
    </div>

    <!-- Media Grid -->
    <div id="media-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
      <div class="col-span-full text-center py-12 text-gray-500">
        <p class="text-lg">No media files loaded yet</p>
        <p class="text-sm mt-2">Enter a folder path or upload files to get started</p>
      </div>
    </div>
  </div>

  <script>
    let socket = null;
    let currentGuildId = null;
    let uploadedFiles = new Map();

    // Initialize Socket.IO connection
    function initializeSocket() {
      socket = io({
        'reconnection': true,
        'reconnectionDelay': 1000,
        'reconnectionDelayMax': 5000,
        'reconnectionAttempts': 999
      });

      socket.on('connect', () => {
        updateConnectionStatus('connected', 'Connected to server');
      });

      socket.on('disconnect', () => {
        updateConnectionStatus('disconnected', 'Disconnected from server');
      });

      socket.on('media-sent', (data) => {
        console.log('Media sent successfully:', data);
        showNotification('Media sent successfully!', 'success');
      });

      socket.on('error', (error) => {
        console.error('Socket error:', error);
        showNotification('Error: ' + error.message, 'error');
      });
    }

    // Update connection status UI
    function updateConnectionStatus(status, text) {
      const statusDiv = document.getElementById('connection-status');
      const statusIcon = document.getElementById('status-icon');
      const statusText = document.getElementById('status-text');

      statusText.textContent = text;

      if (status === 'connected') {
        statusDiv.className = 'mb-6 p-4 rounded-lg bg-green-100 border border-green-300';
        statusIcon.textContent = '✓';
        statusText.className = 'text-green-800';
      } else if (status === 'disconnected') {
        statusDiv.className = 'mb-6 p-4 rounded-lg bg-red-100 border border-red-300';
        statusIcon.textContent = '✗';
        statusText.className = 'text-red-800';
      } else {
        statusDiv.className = 'mb-6 p-4 rounded-lg bg-yellow-100 border border-yellow-300';
        statusIcon.textContent = '⏳';
        statusText.className = 'text-yellow-800';
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Connect to guild
    document.getElementById('connect-btn').addEventListener('click', () => {
      const guildId = document.getElementById('guild-id').value.trim();
      if (!guildId) {
        showNotification('Please enter a Guild ID', 'error');
        return;
      }

      currentGuildId = guildId;
      if (socket) {
        socket.emit('join-room', `messages-${guildId}`);
        showNotification('Connected to guild: ' + guildId, 'success');
      }
    });

    // Load folder
    document.getElementById('load-folder-btn').addEventListener('click', async () => {
      const folderPath = document.getElementById('folder-path').value.trim();
      if (!folderPath) {
        showNotification('Please enter a folder path', 'error');
        return;
      }

      try {
        const response = await fetch(`/control/media-files?folderPath=${encodeURIComponent(folderPath)}`);
        if (!response.ok) {
          throw new Error('Failed to load folder');
        }

        const data = await response.json();
        displayMediaFiles(data.files);
        showNotification(`Loaded ${data.files.length} files`, 'success');
      } catch (error) {
        console.error('Error loading folder:', error);
        showNotification('Error loading folder: ' + error.message, 'error');
      }
    });

    // Handle file upload
    document.getElementById('file-upload').addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      files.forEach((file) => {
        const url = URL.createObjectURL(file);
        uploadedFiles.set(file.name, { file, url, type: file.type });
      });

      displayUploadedFiles();
      showNotification(`Uploaded ${files.length} file(s)`, 'success');
    });

    // Display uploaded files
    function displayUploadedFiles() {
      const mediaFiles = Array.from(uploadedFiles.values()).map(({ file, url, type }) => ({
        name: file.name,
        path: url,
        type: type.startsWith('video') ? 'video' : 'image',
        isUploaded: true
      }));

      displayMediaFiles(mediaFiles);
    }

    // Display media files in grid
    function displayMediaFiles(files) {
      const grid = document.getElementById('media-grid');
      
      if (!files || files.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-500">
            <p class="text-lg">No media files found</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = files.map((file) => `
        <div class="media-card bg-white rounded-lg shadow overflow-hidden cursor-pointer" 
             onclick="sendMediaToStream('${file.path}', '${file.type}', '${file.name}', ${file.isUploaded || false})">
          <div class="relative">
            ${file.type === 'video' ? 
              `<video class="media-thumbnail" src="${file.path}" muted></video>
               <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">VIDEO</div>` :
              `<img class="media-thumbnail" src="${file.path}" alt="${file.name}">
               <div class="absolute top-2 right-2 bg-black bg-opacity-60 text-white px-2 py-1 rounded text-xs">IMAGE</div>`
            }
          </div>
          <div class="p-4">
            <h3 class="font-semibold text-gray-800 truncate">${file.name}</h3>
            <button class="mt-2 w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition text-sm">
              Send to Stream
            </button>
          </div>
        </div>
      `).join('');
    }

    // Send media to stream
    async function sendMediaToStream(path, type, name, isUploaded) {
      if (!currentGuildId) {
        showNotification('Please connect to a guild first', 'error');
        return;
      }

      try {
        let mediaUrl = path;

        // If it's an uploaded file, we need to upload it to the server
        if (isUploaded) {
          const fileData = uploadedFiles.get(name);
          if (!fileData) {
            throw new Error('File not found');
          }

          const formData = new FormData();
          formData.append('file', fileData.file);
          formData.append('guildId', currentGuildId);

          const uploadResponse = await fetch('/control/upload-media', {
            method: 'POST',
            body: formData
          });

          if (!uploadResponse.ok) {
            throw new Error('Failed to upload file');
          }

          const uploadData = await uploadResponse.json();
          mediaUrl = uploadData.url;
        }

        // Send media to stream
        const response = await fetch('/control/send-media', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            guildId: currentGuildId,
            mediaUrl,
            mediaType: type,
            fileName: name
          })
        });

        if (!response.ok) {
          throw new Error('Failed to send media to stream');
        }

        showNotification(`Sent "${name}" to stream!`, 'success');
      } catch (error) {
        console.error('Error sending media:', error);
        showNotification('Error: ' + error.message, 'error');
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initializeSocket();
      
      // Try to load guild ID from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const guildIdParam = urlParams.get('guildId');
      if (guildIdParam) {
        document.getElementById('guild-id').value = guildIdParam;
        document.getElementById('connect-btn').click();
      }
    });
  </script>
</body>

</html>
